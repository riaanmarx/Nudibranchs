<!DOCTYPE html>
<html>
<head>
    <title>Opisthobranchs of Sodwana Bay</title>
    <meta charset="utf-8" />
    <link href="css/Site.css" rel="stylesheet" />
    <link href="css/featherlight.min.css" rel="stylesheet">
    <script src="libs/jquery-3.1.1.min.js"></script>
    <script src="libs/Masonry.js"></script>
    <script src="libs/featherlight.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="js/site.js"></script>
    <script src="js/AddSpecies.js"></script>
    <script>

        // add layout event
        var _postLayout = Masonry.prototype._postLayout;

        Masonry.prototype._postLayout = function () {
            _postLayout.apply(this, arguments);
            this.emitEvent('layout', [this]);
        };

        function addSpec(template, spec) {
            if (spec.wormsid != '') {
                template = template.replace(/<genus \/> <species \/>/g, "<a href='https://www.marinespecies.org/aphia.php?p=taxdetails&id=<wormsid />' target='_blank'><genus /> <species /></a>");
            }
            if (spec.reviewed != 'Y') {
                template = template
                    .replace(/<genus \/>/g, "*<genus />")
            }

            // loop through all the properties of the spec object and replace tags in template
            Object.getOwnPropertyNames(spec).forEach(key => {
                tag = new RegExp(`<${key} />`, "g");
                template = template.replace(tag, spec[key]);
            });

            $("#gridcontainer").append(template);
        }

        function addGridTiles() {
            $.ajaxSetup({
                // Disable caching of AJAX responses
                cache: false
            });

            const urlParams = new URLSearchParams(window.location.search);
            var popuptemplatefile = 'fstemplate.html';
            if (urlParams.has('RM') || urlParams.has('rm')) {
                popuptemplatefile = 'fstemplate_rm.html';
            }
            $.get(popuptemplatefile, function (pu_template) {
                $.get('tiletemplate.html', function (data) {
                    // inject the popup window template
                    data = data.replace(/<popuptemplate \/>/g, pu_template);
                    addSpecies(data);

                    var $container = $('#gridcontainer').masonry({
                        isFitWidth: true,
                        isInitLayout: false
                    });

                    var $proxy = $('#gridcontainer');

                    // bind on layout
                    $container.masonry('on', 'layout', function () {
                        $proxy.width($container.width());
                    });

                    // init masonry
                    $container.masonry();
                }, 'text');
            }, 'text');

            
        }

        function onload() {
            addGridTiles();
        }
    </script>
</head>
<body id="gridpagebody" onload="onload();" oncontextmenu="return false;">
    <div id="pageheaderdiv"></div>
    <div id="pagebodydiv" style="color:silver">
        <div id="gridcontainer"></div>
    </div>
    <div id="pagefooterdiv"></div>
</body>
</html>






































